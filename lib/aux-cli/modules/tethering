#!/bin/bash
set -e

usb_tethering() {
    # Connect via usb and trust after this runs
    sudo apt-get install -y usbmuxd
    sudo systemctl enable usbmuxd
    sudo systemctl start usbmuxd
}

ble_setup() {
    # Install dependencies
    sudo apt-get install -y pi-bluetooth bluez bluez-test-scripts python-dbus
    # Enable BLE
    sudo systemctl enable bluetooth
    # Start BLE
    sudo service bluetooth start
    # Restart BLE
    sudo /etc/init.d/bluetooth restart
    # Add user 'pi' as adin for BLE
    sudo usermod -G bluetooth -a pi
    # Move BLE samples into place
    sudo cp /usr/share/doc/bluez-test-scripts/examples/bluezutils.py /usr/bin
    sudo cp /usr/share/doc/bluez-test-scripts/examples/simple-agent.gz /usr/bin
    sudo gunzip /usr/bin/simple-agent.gz
    # Make sample executable
    sudo chmod +x /usr/bin/simple-agent

    # Get line number of the first line of the definition
    startln=$(grep -n "def RequestAuthorization(self, device):" /usr/bin/simple-agent | cut -f1 -d:)

    # Modify sample
    test=$(grep "auth = ask(\"Authorize? (yes/no): \")" /usr/bin/simple-agent)
    test2="\t\t#auth = ask(\"Authorize? (yes/no): \")"
    sudo sed -i "$((startln + 2))s,$test,$test2,g" /usr/bin/simple-agent

    test=$(grep "if (auth == \"yes\"):" /usr/bin/simple-agent)
    test2="\t\t#if (auth == \"yes\"):"
    sudo sed -i "$((startln + 3))s,$test,$test2,g" /usr/bin/simple-agent

    test="\\t\\t\\treturn"
    test2="\\t\\treturn"
    sudo sed -i "$((startln + 4))s,$test,$test2,g" /usr/bin/simple-agent

    test=$(grep "raise Rejected(\"Pairing rejected\")" /usr/bin/simple-agent)
    test2="\t\t#raise Rejected(\"Pairing rejected\")"
    sudo sed -i "$((startln + 5))s,$test,$test2,g" /usr/bin/simple-agent

    # needs the daemon reloaded after
    sudo sed -i: 's|^Exec.*toothd$| \
ExecStart=/usr/lib/bluetooth/bluetoothd -C \
ExecStartPost=/usr/bin/sdptool add SP \
ExecStartPost=/bin/hciconfig hci0 piscan \
|g' /lib/systemd/system/bluetooth.service

    sudo systemctl daemon-reload

    old_dtimeout=$(grep DiscoverableTimeout /etc/bluetooth/main.conf)
    new_dtimeout="DiscoverableTimeout = 0"
    sudo sed -i "s/$old_dtimeout/$new_dtimeout/g" /etc/bluetooth/main.conf

    old_ptimeout=$(grep PairableTimeout /etc/bluetooth/main.conf)
    new_ptimeout="PairableTimeout = 0"
    sudo sed -i "s/$old_ptimeout/$new_ptimeout/g" /etc/bluetooth/main.conf

    sudo apt-get install pulseaudio-module-bluetooth

}

ble_start() {
    sudo simple-agent
}

dummy() {
    sudo /etc/init.d/bluetooth restart
    sudo service bluetooth start
    sudo service bluetooth status

    sudo hciconfig hci0 sspmode 1
    sudo hciconfig hci0 leadv 0
    sudo hciconfig hci0 inqdata "0c097261737062657272797069020a00091002006b1d460217050d03001801180e110c1115110b1100"
    sudo hciconfig hci0 piscan

    # simple agent
    capability = "NoInputNoOutput"

    # def RequestPinCode(self, device):
    #                 print("RequestPinCode (%s)" % (device))
    #                 return "1234"

}

ble_setup2() {
    # Install dependencies
    sudo apt-get install -y pi-bluetooth bluez bluez-test-scripts python-dbus
    # Enable BLE
    sudo systemctl enable bluetooth
    # Start BLE
    sudo service bluetooth start
    # Restart BLE
    sudo /etc/init.d/bluetooth restart
    # Add user 'pi' as adin for BLE
    sudo usermod -G bluetooth -a pi
    # Move BLE samples into place
    sudo cp /usr/share/doc/bluez-test-scripts/examples/bluezutils.py /usr/bin
    # Move our agent next to the bluez-utilz
    sudo cp /lib/aux-cli/modules/bluez/aux-agent /usr/bin
    # Make sample executable
    sudo chmod +x /usr/bin/aux-agent
}

ble_setup3() {
    /etc/systemd/network/pan-client.network
[Match]
Name=bnep*

[Network]
DHCP=yes

    /etc/systemd/system/pan@.service
[Unit]
Description=Bluetooth Personal Area Network client

[Service]
Type=notify
ExecStart=/usr/local/sbin/bt-pan --debug --systemd client %I --wait

sudo nano /usr/local/sbin/bt-pan



sudo systemctl daemon-reload
sudo systemctl restart systemd-networkd
sudo /etc/init.d/bluetooth restart
sudo systemctl daemon-reload

sudo bluetoothctl <<EOF
agent on
power on
discoverable on
pairable on
default-agent 
EOF


sudo systemctl start pan@E0:B5:2D:09:3B:D8



sudo rm -rf /etc/systemd/network/pan-client.network
sudo rm -rf /etc/systemd/system/pan@.service
sudo rm -rf /etc/systemd/system/pan.service
sudo rm -rf /usr/local/sbin/pan
sudo rm -rf /etc/systemd/network/pan.netdev
sudo rm -rf /etc/systemd/network/pan.network
sudo rm -rf /usr/local/sbin/bt-pan




sudo apt-get install bluez-tools -y
sudo nano /etc/systemd/network/pan0.netdev
[NetDev]
Name=pan0
Kind=bridge
sudo nano /etc/systemd/network/pan0.network
[Match]
Name=pan0

[Network]
Address=172.20.1.1/24
DHCPServer=yes
sudo nano /etc/systemd/system/bt-agent.service
[Unit]
Description=Bluetooth Auth Agent

[Service]
ExecStart=/usr/bin/bt-agent -c NoInputNoOutput
Type=simple

[Install]
WantedBy=multi-user.target
sudo nano /etc/systemd/system/bt-network.service
[Unit]
Description=Bluetooth NEP PAN
After=pan0.network

[Service]
ExecStart=/usr/bin/bt-network -s nap pan0
Type=simple

[Install]
WantedBy=multi-user.target

sudo systemctl enable systemd-networkd
sudo systemctl enable bt-agent
sudo systemctl enable bt-network
sudo systemctl start systemd-networkd
sudo systemctl start bt-agent
sudo systemctl start bt-network
sudo bt-adapter --set Discoverable 1

}
