#!/bin/bash
set -e

read_conf() {
    . /etc/aux-cli.conf
}

usb_tethering() {
    # Connect via usb and trust after this runs
    sudo apt-get install -y usbmuxd
    sudo systemctl enable usbmuxd
    sudo systemctl start usbmuxd
}

ble_tethering() {
    sudo apt-get install -y bluez-tools python-dbus python-gobject python-gobject-2 git

    old_dtimeout=$(grep DiscoverableTimeout /etc/bluetooth/main.conf)
    new_dtimeout="DiscoverableTimeout = 0"
    sudo sed -i "s/$old_dtimeout/$new_dtimeout/g" /etc/bluetooth/main.conf

    old_ptimeout=$(grep PairableTimeout /etc/bluetooth/main.conf)
    new_ptimeout="PairableTimeout = 0"
    sudo sed -i "s/$old_ptimeout/$new_ptimeout/g" /etc/bluetooth/main.conf
}

install() {
    usb_tethering
    ble_tethering
    sudo sed -i "s/tethering=\"false\"/tethering=\"true\"/g" /etc/aux-cli.conf
}

uninstall() {
    sudo apt autoremove
    sudo apt-get remove -y usbmuxd
    sudo apt-get remove -y bluez-tools
    sudo apt autoremove
    
    sudo rm -rf /etc/systemd/network/pan0.netdev
    sudo rm -rf /etc/systemd/network/pan0.network
    sudo rm -rf /etc/systemd/system/bt-agent.service
    sudo rm -rf /etc/systemd/system/bt-network.service
    sudo systemctl disable systemd-networkd
    sudo systemctl stop systemd-networkd
    sudo sed -i "s/tethering=\"true\"/tethering=\"false\"/g" /etc/aux-cli.conf
}

read_conf

if [ "$1" == "uninstall" ]; then
    if [ $tethering == "true" ]; then
        uninstall
    else
        echo "Tethering is not installed. Skipping uninstallation."
    fi
else
    if [ $tethering == "false" ]; then
        install
    else
        echo "Tethering is already installed. Skipping installation."
    fi
fi
