#!/bin/bash
set -e

echo "Starting reboot operations."

log="/var/log/aux-cli.pi.startup.log"
dnsmasq_conf="/etc/dnsmasq.conf"
hostapd_conf="/etc/hostapd/hostapd.conf"
dhcpcd_conf="/etc/dhcpcd.conf"
wpa_conf="/etc/wpa_supplicant/wpa_supplicant.conf"

read_conf() {
    . /etc/aux-cli.conf
}

wlan_checker() {
    echo "Checking for wlan1..."
    # Check if there is an extra wlan present and use it
    if grep wlan1 /proc/net/dev; then
        echo "Found wlan1. Changing default from wlan0..."
        sudo sed -i "s/^interface=wlan0/interface=wlan1/g" "${dnsmasq_conf}"
        sudo sed -i "s/^interface=wlan0/interface=wlan1/g" "${hostapd_conf}"
        sudo sed -i "s/^interface wlan0/interface wlan1/g" "${dhcpcd_conf}"
    fi
}

dnsmasq_checker() {
    echo "Checking for dnsmasq..."
    if [ -e "${dnsmasq_conf}" ]; then
        echo "Extending IP range and timeout for dnsmasq..."
        # Give a larger default range of IP Addresses with a longer timeout
        if sudo grep "^dhcp-range=" "${dnsmasq_conf}"; then
            sudo sed -i "s/^dhcp-range=.*/dhcp-range=10.0.0.10,10.0.0.110,12h/g" "${dnsmasq_conf}"
        else
            echo "dhcp-range=10.0.0.10,10.0.0.110,12h" | sudo tee -a "${dnsmasq_conf}"
        fi

        echo "Verifying 'auxplayer.com' address is present..."
        # Add the auxplayer name
        if ! sudo grep "address=/auxplayer.com/10.0.0.1" "${dnsmasq_conf}"; then
            echo "address=/auxplayer.com/10.0.0.1" | sudo tee -a "${dnsmasq_conf}"
        fi
    fi
}

wpa_checker() {
    echo "Checking for wpa_supplicant..."
    if [ -e "${wpa_conf}" ]; then
        echo "Found wpa_supplicant. Verifying country and scan_ssid values..."
        if sudo grep "country=" "${wpa_conf}"; then
            sudo sed -i "s/^country=.*/country=US/g" "${wpa_conf}"
        else
            line_number=$(sudo grep -ne '^$' "${wpa_conf}" | grep -Eo '^[^:]+')
            sudo sed -i "${line_number}i country=US" "${wpa_conf}"
        fi

        if sudo grep "scan_ssid=" "${wpa_conf}"; then
            sudo sed -i "s/^scan_ssid=.*/scan_ssid=1/g" "${wpa_conf}"
        else
            line_number=$(sudo grep -n "network=" "${wpa_conf}" | grep -Eo '^[^:]+')
            line_number=$((line_number + 1))
            sudo sed -i "${line_number}i \\ \\ \\ \\ scan_ssid=1" "${wpa_conf}"
        fi
    fi
}

mac_check() {
    echo "Checking the MAC..."
    oldfour=$(grep -Eo "ssid=.*? ...." /etc/hostapd/hostapd.conf | tail -c 5)
    newfour=$(tail -c 6 /sys/class/net/eth0/address | tr --delete :)
}

mac_set() {
    echo "Updating the MAC..."
    if [ "$oldfour" != "$newfour" ]; then
        sudo sed -i "s/$oldfour/$newfour/g" /etc/hostapd/hostapd.conf
        reboot_required="true"
        echo "MAC has been updated."
    else
        echo "MAC Address matches."
    fi
}

hostname_check() {
    echo "Checking the hostname..."
    oldhost=$(grep -Eo "ssid=.*" /etc/hostapd/hostapd.conf | sed 's/.\{5\}$//' | sed "s/^ssid=//g")
    oldhost2=$(grep -Eo "ssid_prefix=.*" /etc/raspiwifi/raspiwifi.conf | sed "s/^ssid_prefix=//g")
}

hostname_set() {
    echo "Updating the hostname in relevant files..."
    if [ "$(hostname)" != "$oldhost" ]; then
        sudo sed -i "s/$oldhost/$(hostname)/g" /etc/hostapd/hostapd.conf
        reboot_required="true"
    else
        echo "OldHost matches NewHost."
    fi
    if [ "$(hostname)" != "$oldhost2" ]; then
        sudo sed -i "s/$oldhost2/$(hostname)/g" /etc/raspiwifi/raspiwifi.conf
        reboot_required="true"
    else
        echo "OldHost2 matches NewHost."
    fi
}

reboot_check() {
    echo "Checking if reboot required..."
    if [ "$reboot_required" == "true" ]; then
        echo "Reboot is required. Rebooting now..."
        sudo reboot now
    else
        echo "No reboot required."
    fi
}

usbmount_docker_check() {
    echo "Waiting to usbmount to docker..."
    if ! docker inspect -f '{{.State.Running}}' pi_server_1; then
        echo "Docker is not up yet..."
        sleep 2
    else
        echo "Docker is up!"
        currentMounts=$(sudo mount | grep "/dev/sd[a-z][0-9]" | grep -vE "docker" | grep -vE "(/|/boot) " | awk '{print $1,$3}')
        for i in "${!currentMounts[@]}"; do
            if [[ "${currentMounts[i]}" == *[!\ ]* ]]; then
                echo "Unmounting USB Device: ${currentMounts[i]}"
                sudo umount $(echo "${currentMounts[i]}" | awk '{print $2}' | xargs echo -n)
                echo "Mounting USB Device: ${currentMounts[i]}"
                sudo mount $(echo "${currentMounts[i]}" | awk '{print $1,$2}')
            fi
        done
    fi
}

bluetooth_start() {

    echo "Starting up bluetoothctl..."
    # Crontab is running as user 'pi' but this needs to run as user 'root'
    sudo -u root bluetoothctl <<EOF
power on
discoverable on
pairable on
EOF
}

bluetooth_broadcast() {
    echo "Converting hostname to hex for broadcasting..."
    STR=$(hostname)
    HEXVAL=$(xxd -pu <<<"$STR")
    HEXVAL=${HEXVAL::-2}
    HEXLEN=${#HEXVAL}

    while [ $HEXLEN -lt 22 ]; do
        HEXVAL="${HEXVAL}0"
        HEXLEN=${#HEXVAL}
        echo $HEXVAL
        echo $HEXLEN
    done

    INQ="0c09${HEXVAL}020a00091002006b1d460217050d03001801180e110c1115110b1100"
    echo $INQ

    echo "Starting Bluetooth broadcast..."
    sudo hciconfig hci0 sspmode 1
    sudo hciconfig hci0 inqdata $INQ
    sudo /usr/bin/bt-agent -c NoInputNoOutput &
}

bluetooth_hotspot_check() {
    echo "Starting infinite loop that checks for connected bluetooth devices..."
    while $bluetooth_hotspot; do
        sudo python /lib/aux-cli/modules/ble/list-bt-devices.py &
        sleep 5
        read_conf
    done
}

run_steps() {
    reboot_required="false"
    read_conf
    wlan_checker
    dnsmasq_checker
    wpa_checker

    if [ $raspiwifi == "true" ]; then
        mac_check
        mac_set
        hostname_check
        hostname_set
        reboot_check
    fi

    if [ $first_run == "true" ]; then
        aux-cli start
        sudo sed -i "s/first_run=\"true\"/first_run=\"false\"/g" /etc/aux-cli.conf
    fi

    if [ $tethering == "true" ] && [ $bt_mode == "serial" ]; then
        systemctl start bt-serial-scan
    fi

    if [ $tethering == "true" ] && [ $bt_mode == "tether" ]; then
        bluetooth_start
        bluetooth_broadcast
        bluetooth_hotspot_check
    fi
}


# printf "\n\n########################################\n" | sudo tee -a "${log}"
# date +%Y\/%m\/%d_%I:%M%p | sudo tee -a "${log}"

run_steps # | sudo tee -a "${log}"
