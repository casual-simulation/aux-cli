#!/bin/bash
set -e

if [ -f /etc/auxcli/config.json ]; then
    verbose=$(jq -r '.verbose' /etc/auxcli/config.json) 
else
    verbose=false
fi

# Temporarily add this dir to the path so we can use helper commands
PATH=$PATH:/lib/auxcli/commands/helper

commands_config="/etc/auxcli/commands.json"
commands=($(jq -r '.[] | select( .available != null) | .name' $commands_config))

# readarray splits each newline into one element in the array
readarray -t commands_desc < <(jq -r '.[] | select( .available != null) | .short_desc' $commands_config)

usage() {
    printf "\nUsage:        auxcli [COMMAND]\n\n"
    printf "Command line tools for AUX dealing more with the hardware/server than auxplayer itself.\n\n"
    printf "COMMANDS:\n"
    for ((i = 0; i < ${#commands[@]}; i++)); do
        if available ${commands[$i]}; then
            # \t        Tab
            # [ ]       Marked if available
            # %-24s     Left-Aligned column 24 spaces wide that contains the first 's' string
            # \t        Tabs
            # %s        The second string passed as an argument
            # \n        Newline
            printf "\t[x] %-24s\t%s\n" "${commands[$i]}" "${commands_desc[$i]}"
        else
            printf "\t[ ] %-24s\t%s\n" "${commands[$i]}" "${commands_desc[$i]}"
        fi
    done
    printf "\t%-4s\t\t\t\t%s\n" "help" "Displays this usage information."
    printf "\nRun 'auxcli COMMAND --help' for more information on a command.\n\n"
    exit 1
}

err_check() {
    # First error check
    # Show the usage menu if there aren't any arguments after `auxcli`
    # or if the command is "help"
    if $verbose; then printf "DEBUG (auxcli): First error check.\n"; fi
    if [ $# -eq 0 ] || [ $1 == "help" ]; then
        usage
    fi

    # Second error check
    # Throw an error messege if the first argument isn't a command
    if $verbose; then printf "DEBUG (auxcli): Second error check.\n"; fi
    if [[ ! ${commands[*]} =~ $1 ]]; then
        printf "\n\"$1\" is not a valid command.\n"
        printf "Run 'auxcli help' for help.\n\n"
        exit 1
    fi

    # Third error check
    # Throw an error messege if the first argument isn't an available command
    if $verbose; then printf "DEBUG (auxcli): Third error check.\n"; fi
    if ! available $1; then
        printf "\nThe \"$1\" command is not available. Install the correct component first.\n\n"
        exit 1
    fi
}

run_cmd() {
    # Set the first argument to be the command and then shift past it
    command_path=$(jq --arg cmd "$1" -r '.[] | select( .name == $cmd ) | .command_path' $commands_config)
    if $verbose; then printf "DEBUG (auxcli): The command path is %s.\n" "$command_path"; fi
    shift

    # Add all other arguments to an array
    while [[ $# -gt 0 ]]; do
        if $verbose; then printf "DEBUG (auxcli): Adding %s to the command argument array.\n" "$1"; fi
        command_args+=("$1")
        shift
    done

    # If there are no arguments for the command, just run the command
    if [ ${#command_args[@]} -eq 0 ]; then
        if $verbose; then printf "DEBUG (auxcli): Running command: %s\n" "${command_path}"; fi
        . "${command_path}"
    else
        if $verbose; then printf "DEBUG (auxcli): Running command with args: %s %s\n" "${command_path}" "${command_args[*]}"; fi
        . "${command_path}" "${command_args[@]}"
    fi
}

err_check "$@"
run_cmd "$@"

if jq -r '.reboot_required' /etc/auxcli/config.json 1> /dev/null; then
    printf "You need to reboot for the changes to take effect."
    if jq -r '.reboot_on_exit' /etc/auxcli/config.json 1> /dev/null; then
        printf "Rebooting now."
        sudo reboot now
    else
        read -rep $'Press "y" to reboot now or press anything else to wait.\n' -n 1 -r
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            printf "Rebooting now."
            sudo reboot now
        fi
    fi
fi